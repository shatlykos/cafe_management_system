{% extends "base.html" %}
{% block title %}Завтраки — GALAXY FOOD{% endblock %}
{% block content %}

<div class="flex-between">
  <h1>☕ Завтраки</h1>
  <button class="btn btn-gold" onclick="openModal('modal-add-client')">+ Новый клиент</button>
</div>

<p style="color:#888; margin-bottom:20px; font-size:14px;">
  Правило: каждый <strong>7-й завтрак</strong> за всё время — <strong style="color:#2E7D32;">БЕСПЛАТНО</strong>
</p>

<div class="form-box" style="margin-bottom:18px;">
  <form method="POST" action="{{ url_for('scan_breakfast_by_barcode') }}">
    <div class="form-row" style="align-items:end;">
      <div class="form-group" style="min-width:280px;">
        <label>Сканировать штрихкод</label>
        <input type="text" name="barcode" placeholder="Отсканируйте EAN-13 код" autofocus required>
      </div>
      <div class="form-group">
        <label>Дата</label>
        <input type="date" name="date" value="{{ request.args.get('date', '') or today }}">
      </div>
      <div class="form-group" style="flex:0 0 auto;">
        <button class="btn btn-green" type="submit">Сканировать и записать</button>
      </div>
    </div>
  </form>
</div>

{% if client_data %}
<div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>Клиент</th>
        <th>Баркод</th>
        <th>Телефон</th>
        <th>Завтраков всего</th>
        <th>До бесплатного</th>
        <th>Действия</th>
      </tr>
    </thead>
    <tbody>
      {% for item in client_data %}
      {% set c = item.client %}
      {% set s = item.stats %}
      <tr>
        <td>
          <strong>{{ c.name }}</strong>
          {% if s.next_is_free %}
            <span class="badge badge-warn" style="margin-left:8px;">⭐ Следующий бесплатный!</span>
          {% endif %}
        </td>
        <td><code>{{ c.barcode }}</code></td>
        <td>{{ c.phone or '—' }}</td>
        <td>
          <div style="display:flex; align-items:center; gap:10px;">
            <span style="font-size:18px; font-weight:800;">{{ s.count_total }}</span>
            <div style="flex:1; min-width:80px;">
              <div class="progress-wrap">
                <div class="progress-bar" style="width: {{ [(s.count_total % 7) / 6 * 100, 100]|min }}%"></div>
              </div>
            </div>
          </div>
        </td>
        <td>
          {% if s.next_is_free %}
            <span class="badge badge-warn">⭐ Следующий!</span>
          {% else %}
            <span style="font-weight:700;">{{ s.visits_until_free }}</span>
          {% endif %}
        </td>
        <td style="display:flex; gap:8px; flex-wrap:wrap;">
          <a href="{{ url_for('client_barcode_svg', client_id=c.id) }}" target="_blank" class="btn btn-sm" style="background:var(--cream-dark); color:var(--brown);">Штрихкод</a>
          <form method="POST" action="{{ url_for('register_breakfast') }}" style="display:inline;">
            <input type="hidden" name="client_id" value="{{ c.id }}">
            <input type="hidden" name="date" value="{{ request.args.get('date', '') }}">
            <button class="btn btn-green btn-sm" type="submit">✔ Записать завтрак</button>
          </form>
          <a href="{{ url_for('breakfast_history', client_id=c.id) }}" class="btn btn-sm" style="background:var(--cream-dark); color:var(--brown);">История</a>
          <form method="POST" action="{{ url_for('delete_client', client_id=c.id) }}" style="display:inline;"
                onsubmit="return confirm('Удалить клиента {{ c.name }}?')">
            <button class="btn btn-red btn-sm" type="submit">✕</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="form-box" style="text-align:center; padding:40px;">
  <div style="font-size:48px;">☕</div>
  <p style="font-size:18px; margin-top:12px; color:#888;">Клиентов пока нет. Добавьте первого!</p>
  <button class="btn btn-gold mt-16" onclick="openModal('modal-add-client')">+ Добавить клиента</button>
</div>
{% endif %}

<!-- Модальное окно: добавить клиента -->
<div class="modal-bg" id="modal-add-client">
  <div class="modal">
    <span class="modal-close" onclick="closeModal('modal-add-client')">✕</span>
    <h2>Новый клиент</h2>
    <form method="POST" action="{{ url_for('add_client') }}">
      <div class="form-group" style="margin-bottom:14px;">
        <label>Имя *</label>
        <input type="text" name="name" placeholder="Например: Айгуль" required autofocus>
      </div>
      <div class="form-group" style="margin-bottom:14px;">
        <label>Телефон</label>
        <div style="display:flex; align-items:center; gap:8px;">
          <span style="padding:10px 12px; border:2px solid var(--cream-dark); border-radius:8px; background:var(--cream); font-weight:700; color:var(--brown);">+995</span>
          <input type="text" name="phone_local" placeholder="5XXXXXXXX" inputmode="numeric" pattern="[0-9]{9}">
        </div>
      </div>
      <div class="form-group" style="margin-bottom:20px;">
        <label>Примечания</label>
        <input type="text" name="notes" placeholder="Необязательно">
      </div>
      <button class="btn btn-gold btn-block" type="submit">Добавить клиента</button>
    </form>
  </div>
</div>

{% endblock %}
