{% extends "base.html" %}
{% block title %}–ò—Å—Ç–æ—Ä–∏—è –∫–æ—Ñ–µ ‚Äî {{ client.name }}{% endblock %}
{% block content %}

<div class="flex-between">
  <h1>–ò—Å—Ç–æ—Ä–∏—è –∫–æ—Ñ–µ: {{ client.name }}</h1>
  <a href="{{ url_for('coffee') }}" class="btn btn-brown">‚Üê –ù–∞–∑–∞–¥</a>
</div>

<div class="cards" style="margin-top:16px;">
  <div class="card">
    <div class="card-label">–¶–∏–∫–ª (30 –¥–Ω–µ–π)</div>
    <div class="card-value">{{ stats.cycle_step }}/7</div>
    <div class="card-sub">–ó–∞ 30 –¥–Ω–µ–π: {{ stats.count_30_days }}</div>
  </div>
  <div class="card">
    <div class="card-label">–î–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ</div>
    <div class="card-value">
      {% if stats.next_is_free %}‚≠ê{% else %}{{ stats.visits_until_free }}{% endif %}
    </div>
    {% if stats.next_is_free %}
    <div class="card-sub" style="color:#2E7D32; font-weight:700;">–°–ª–µ–¥—É—é—â–∏–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π!</div>
    {% endif %}
  </div>
  <div class="card">
    <div class="card-label">–®—Ç—Ä–∏—Ö–∫–æ–¥</div>
    <div style="margin-top:8px; font-family:monospace; font-size:18px; font-weight:700;">{{ client.barcode }}</div>
    <a href="{{ url_for('client_barcode_svg', client_id=client.id) }}" target="_blank" class="btn btn-sm mt-16" style="background:var(--cream-dark); color:var(--brown);">–û—Ç–∫—Ä—ã—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥</a>
  </div>
  <div class="card">
    <div class="card-label">–í—Å–µ–≥–æ –∫–æ—Ñ–µ</div>
    <div class="card-value">{{ visits|length }}</div>
    <div class="card-sub">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö: {{ visits|selectattr('is_free')|list|length }}</div>
  </div>
</div>

{% if visits %}
<div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>–î–∞—Ç–∞</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
      </tr>
    </thead>
    <tbody>
      {% for v in visits %}
      <tr>
        <td style="color:#aaa;">{{ loop.index }}</td>
        <td>{{ v.date }}</td>
        <td>
          {% if v.is_free %}
            <span class="badge badge-free">üéâ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
          {% else %}
            <span class="badge badge-paid">–ü–ª–∞—Ç–Ω—ã–π</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="form-box" style="text-align:center; padding:40px;">
  <p style="color:#888; font-size:16px;">–ö–æ—Ñ–µ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
</div>
{% endif %}

<h2 style="margin-top:20px;">–ò—Å—Ç–æ—Ä–∏—è —à—Ç—Ä–∏—Ö–∫–æ–¥–∞</h2>
{% if events %}
<div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
        <th>–°–æ–±—ã—Ç–∏–µ</th>
        <th>–î–µ—Ç–∞–ª–∏</th>
      </tr>
    </thead>
    <tbody>
      {% for e in events %}
      <tr>
        <td>{{ e.event_date }}</td>
        <td><span class="badge badge-gold">{{ e.event_type }}</span></td>
        <td>{{ e.details or '‚Äî' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="form-box" style="text-align:center; padding:20px;">
  <p style="color:#888; font-size:15px;">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É.</p>
</div>
{% endif %}

{% endblock %}
