{% extends "base.html" %}
{% block title %}Клиентский профиль{% endblock %}
{% block content %}

{% if not client %}
<h1>Профиль не найден</h1>
<div class="form-box">
  <p style="color:#888;">Ссылка недействительна или устарела.</p>
</div>
{% else %}
<div class="flex-between">
  <h1>Ваш профиль: {{ client.name }}</h1>
</div>

<div class="cards" style="margin-top:16px;">
  <div class="card">
    <div class="card-label">Ваш штрихкод</div>
    <div style="margin-top:8px; font-family:monospace; font-size:18px; font-weight:700;">{{ client.barcode }}</div>
    <img src="{{ url_for('client_barcode_svg', client_id=client.id) }}" alt="barcode" style="margin-top:12px; max-width:100%;">
  </div>
  <div class="card">
    <div class="card-label">Цикл (30 дней)</div>
    <div class="card-value">{{ stats.cycle_step }}/7</div>
    <div class="card-sub">За 30 дней: {{ stats.count_30_days }} | Всего: {{ stats.count_total }}</div>
  </div>
  <div class="card">
    <div class="card-label">До бесплатного</div>
    <div class="card-value">{% if stats.next_is_free %}⭐{% else %}{{ stats.visits_until_free }}{% endif %}</div>
  </div>
  <div class="card">
    <div class="card-label">Кофе: цикл (30 дней)</div>
    <div class="card-value">{{ coffee_stats.cycle_step }}/7</div>
    <div class="card-sub">За 30 дней: {{ coffee_stats.count_30_days }} | Всего: {{ coffee_stats.count_total }}</div>
  </div>
</div>

<h2>История завтраков</h2>
{% if visits %}
<div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>Дата</th>
        <th>Статус</th>
      </tr>
    </thead>
    <tbody>
      {% for v in visits %}
      <tr>
        <td>{{ v.date }}</td>
        <td>
          {% if v.is_free %}
            <span class="badge badge-free">Бесплатно</span>
          {% else %}
            <span class="badge badge-paid">Платный</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="form-box">
  <p style="color:#888;">История пока пуста.</p>
</div>
{% endif %}

<h2 style="margin-top:20px;">История кофе</h2>
{% if coffee_visits %}
<div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>Дата</th>
        <th>Статус</th>
      </tr>
    </thead>
    <tbody>
      {% for v in coffee_visits %}
      <tr>
        <td>{{ v.date }}</td>
        <td>
          {% if v.is_free %}
            <span class="badge badge-free">Бесплатно</span>
          {% else %}
            <span class="badge badge-paid">Платный</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="form-box">
  <p style="color:#888;">История кофе пока пуста.</p>
</div>
{% endif %}

<h2 style="margin-top:20px;">История штрихкода</h2>
{% if events %}
<div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>Дата и время</th>
        <th>Событие</th>
        <th>Детали</th>
      </tr>
    </thead>
    <tbody>
      {% for e in events %}
      <tr>
        <td>{{ e.event_date }}</td>
        <td><span class="badge badge-gold">{{ e.event_type }}</span></td>
        <td>{{ e.details or '—' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}
{% endif %}

{% endblock %}
